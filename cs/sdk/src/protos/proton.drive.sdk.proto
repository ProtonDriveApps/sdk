edition = "2023";
package proton.drive.sdk;

option features.utf8_validation = NONE;
option csharp_namespace = "Proton.Drive.Sdk.CExports";

import "proton.sdk.proto";
import "google/protobuf/timestamp.proto";

message Request {
    oneof payload {
        DriveClientCreateRequest drive_client_create = 1000;
        DriveClientCreateFromSessionRequest drive_client_create_from_session = 1001;
        DriveClientFreeRequest drive_client_free = 1002;
        DriveClientGetFileUploaderRequest drive_client_get_file_uploader = 1003;
        DriveClientGetFileRevisionUploaderRequest drive_client_get_file_revision_uploader = 1004;
        DriveClientGetFileDownloaderRequest drive_client_get_file_downloader = 1005;
        DriveClientGetAvailableNameRequest drive_client_get_available_name = 1006;
        DriveClientGetThumbnailsRequest drive_client_get_thumbnails = 1007;

        UploadFromStreamRequest upload_from_stream = 1100;
        UploadFromFileRequest upload_from_file = 1101;
        FileUploaderFreeRequest file_uploader_free = 1102;
        UploadControllerAwaitCompletionRequest upload_controller_await_completion = 1103;
        UploadControllerPauseRequest upload_controller_pause = 1104;
        UploadControllerResumeRequest upload_controller_resume = 1105;
        UploadControllerFreeRequest upload_controller_free = 1106;

        DownloadToStreamRequest download_to_stream = 1200;
        DownloadToFileRequest download_to_file = 1201;
        FileDownloaderFreeRequest file_downloader_free = 1202;
        DownloadControllerAwaitCompletionRequest download_controller_await_completion = 1203;
        DownloadControllerPauseRequest download_controller_pause = 1204;
        DownloadControllerResumeRequest download_controller_resume = 1205;
        DownloadControllerFreeRequest download_controller_free = 1206;
    };
}

// Account client interface

message AccountRequest {
    oneof payload {
        GetAddressRequest get_address = 1;
        GetDefaultAddressRequest get_default_address = 2;
        GetAddressPrimaryPrivateKeyRequest get_address_primary_private_key = 3;
        GetAddressPrivateKeysRequest get_address_private_keys = 4;
        GetAddressPublicKeysRequest get_address_public_keys = 5;
    };
}

// The response value must be an Address.
message GetAddressRequest {
    string address_id = 1;
}

// The response value must be an Address.
message GetDefaultAddressRequest {
}

// The response value must be a BytesValue.
message GetAddressPrimaryPrivateKeyRequest {
    string address_id = 1;
}

// The response value must be a RepeatedBytesValue.
message GetAddressPrivateKeysRequest {
    string address_id = 1;
}

// The response value must be a RepeatedBytesValue.
message GetAddressPublicKeysRequest {
    string email_address = 1;
}

// Drive - client

enum ThumbnailType {
    THUMBNAIL_TYPE_UNSPECIFIED = 0; // Invalid value
    THUMBNAIL_TYPE_THUMBNAIL = 1;
    THUMBNAIL_TYPE_PREVIEW = 2;
}

message FileRevision {
    string uid = 1;
    google.protobuf.Timestamp creation_time = 2;
    int64 size_on_cloud_storage = 3;
    int64 claimed_size = 4; // Optional
    google.protobuf.Timestamp claimed_modification_time = 5; // Optional
}

message FileNode {
    string uid = 1;
    string parent_uid = 2;
    string name = 3;
    string media_type = 4;
    int64 total_size_on_cloud_storage = 5;
    FileRevision active_revision = 6;
}

message ProgressUpdate {
    int64 bytes_completed = 1;
    int64 bytes_in_total = 2;
}

message Thumbnail {
    ThumbnailType type = 1;
    int64 data_pointer = 2;
    int64 data_length = 3;
}

message FileThumbnail {
    string file_uid = 1;
    bytes data = 2;
}

message FileThumbnailList {
    repeated FileThumbnail thumbnails = 1;
}

message UploadResult {
    string node_uid = 1;
    string revision_uid = 2;
}

message HttpClient {
    // Pointer to C function that will be called:
    // intptr_t handle_http_request(intptr_t bindings_handle, ByteArray http_request, intptr_t sdk_handle)
    //   bindings_handle: handle for the bindings
    //   http_request: Protobuf message of type proton.sdk.HttpRequest carrying the HTTP request data
    //   sdk_handle: handle for the SDK
    // Returns a cancellation handle to be passed to the cancellation action. That handle can be freed after the request is completed, but there could be
    // a race condition where the cancellation is still called after the request is completed, so this must be accounted for.
    int64 request_function = 1;
    int64 response_content_read_action = 2; // C signature: void handle_http_response_read(intptr_t bindings_handle, ByteArray buffer, intptr_t sdk_handle);
    int64 cancellation_action = 3; // C signature: void handle_http_cancellation(intptr_t bindings_operation_handle);
}

// The response value must be an Int64Value carrying a handle to an instance of ProtonDriveClient.
message DriveClientCreateRequest {
    string base_url = 1;
    string bindings_language = 2; // Optional

    HttpClient http_client = 3;
    
    // Pointer to C function that will be called:
    // void handle_account_request(intptr_t bindings_handle, ByteArray http_request, intptr_t sdk_handle)
    //   bindings_handle: handle for the bindings
    //   account_request: Protobuf message of type proton.drive.sdk.AccountRequest carrying the request data
    //   sdk_handle: handle for the SDK
    int64 account_request_action = 6;

    string entity_cache_path = 7; // Optional
    string secret_cache_path = 8; // Optional

    proton.sdk.Telemetry telemetry = 9; // Optional

    // Client UID, optional 
    // If a null value is provided, the SDK automatically generates a UUID during initialization
    string uid = 10;

    // Pointer to C function that will be called to check feature flags:
    // int is_feature_flag_enabled(intptr_t bindings_handle, ByteArray flag_name)
    //   bindings_handle: handle for the bindings
    //   flag_name: UTF-8 encoded feature flag name
    //   returns: 0 for disabled, non-zero for enabled
    int64 feature_enabled_function = 11; // Optional
}

// The response value must be an Int64Value carrying a handle to an instance of ProtonDriveClient.
message DriveClientCreateFromSessionRequest {
    int64 session_handle = 1;
}

// The reponse must not have a value.
message DriveClientFreeRequest {
    int64 client_handle = 1;
}

// Drive - uploads

message AdditionalMetadataProperty {
    string name = 1;
    bytes utf8_json_value = 2;
}

// The response value must be an Int64Value carrying a handle to an instance of FileUploader.
message DriveClientGetFileUploaderRequest {
    int64 client_handle = 1;
    string parent_folder_uid = 2;
    string name = 3;
    string mediaType = 4;
    int64 size = 5;
    google.protobuf.Timestamp last_modification_time = 6;
    repeated AdditionalMetadataProperty additional_metadata = 7; // Optional
    bool override_existing_draft_by_other_client = 8;
    int64 cancellation_token_source_handle = 9;
}

// The response value must be an Int64Value carrying a handle to an instance of FileUploader.
message DriveClientGetFileRevisionUploaderRequest {
    int64 client_handle = 1;
    string current_active_revision_uid = 2;
    int64 size = 3;
    google.protobuf.Timestamp last_modification_time = 4;
    repeated AdditionalMetadataProperty additional_metadata = 5; // Optional
    int64 cancellation_token_source_handle = 6;
}

// The response value must be an Int64Value carrying a handle to an instance of UploadController.
message UploadFromStreamRequest {
    int64 uploader_handle = 1;
    repeated Thumbnail thumbnails = 2;
    int64 read_action = 3; // C signature: void handle_stream_operation(intptr_t bindings_handle, ByteArray buffer, intptr_t sdk_handle);
    int64 progress_action = 4; // See array_action in C header file for signature
    int64 cancellation_token_source_handle = 5;
}

// The response value must be an Int64Value carrying a handle to an instance of UploadController.
message UploadFromFileRequest {
    int64 uploader_handle = 1;
    repeated Thumbnail thumbnails = 2;
    string file_path = 3;
    int64 progress_action = 4; // See array_action in C header file for signature
    int64 cancellation_token_source_handle = 5;
}

// The reponse must not have a value.
message FileUploaderFreeRequest {
    int64 file_uploader_handle = 1;
}

// The response message must be of type UploadResult.
message UploadControllerAwaitCompletionRequest {
    int64 upload_controller_handle = 1;
}

// The reponse must not have a value.
message UploadControllerPauseRequest {
    int64 upload_controller_handle = 1;
}

// The reponse must not have a value.
message UploadControllerResumeRequest {
    int64 upload_controller_handle = 1;
}

// The reponse must not have a value.
message UploadControllerFreeRequest {
    int64 upload_controller_handle = 1;
}

// The response message must be of type String.
message DriveClientGetAvailableNameRequest {
    int64 client_handle = 1;
    string parent_folder_uid = 2;
    string name = 3;
    int64 cancellation_token_source_handle = 4;
}

// The response message must be of type FileThumbnailList.
message DriveClientGetThumbnailsRequest {
    int64 client_handle = 1;
    repeated string file_uids = 2;
    ThumbnailType type = 3;
    int64 cancellation_token_source_handle = 4;
}

// Drive - downloads

// The response value must be an Int64Value carrying a handle to an instance of FileDownloader.
message DriveClientGetFileDownloaderRequest {
    int64 client_handle = 1;
    string revision_uid = 2;
    int64 cancellation_token_source_handle = 3;
}

// The response value must be an Int64Value carrying a handle to an instance of DownloadController.
message DownloadToStreamRequest {
    int64 downloader_handle = 1;
    int64 write_action = 2; // C signature: void on_stream_operation(intptr_t bindings_handle, ByteArray buffer, intptr_t sdk_handle);
    int64 progress_action = 3; // See array_action in C header file for signature
    int64 cancellation_token_source_handle = 4;
}

// The response value must be an Int64Value carrying a handle to an instance of DownloadController.
message DownloadToFileRequest {
    int64 downloader_handle = 1;
    string file_path = 2;
    int64 progress_action = 3; // See array_action in C header file for signature
    int64 cancellation_token_source_handle = 4;
}

// The reponse must not have a value.
message FileDownloaderFreeRequest  {
    int64 file_downloader_handle = 1;
}

// The reponse must not have a value.
message DownloadControllerAwaitCompletionRequest {
    int64 download_controller_handle = 1;
}

// The reponse must not have a value.
message DownloadControllerPauseRequest {
    int64 download_controller_handle = 1;
}

// The reponse must not have a value.
message DownloadControllerResumeRequest {
    int64 download_controller_handle = 1;
}

// The reponse must not have a value.
message DownloadControllerFreeRequest {
    int64 download_controller_handle = 1;
}

enum VolumeType {
    VOLUME_TYPE_OWN_VOLUME = 0;
    VOLUME_TYPE_SHARED = 1;
    VOLUME_TYPE_SHARED_PUBLIC = 2;
    VOLUME_TYPE_PHOTO = 3;
}

enum DownloadError {
    DOWNLOAD_ERROR_SERVER_ERROR = 0;
    DOWNLOAD_ERROR_NETWORK_ERROR = 1;
    DOWNLOAD_ERROR_DECRYPTION_ERROR = 2;
    DOWNLOAD_ERROR_INTEGRITY_ERROR = 3;
    DOWNLOAD_ERROR_RATE_LIMITED = 4;
    DOWNLOAD_ERROR_HTTP_CLIENT_SIDE_ERROR = 5;
    DOWNLOAD_ERROR_UNKNOWN = 6;
}

enum UploadError {
    UPLOAD_ERROR_SERVER_ERROR = 0;
    UPLOAD_ERROR_NETWORK_ERROR = 1;
    UPLOAD_ERROR_INTEGRITY_ERROR = 2;
    UPLOAD_ERROR_RATE_LIMITED = 3;
    UPLOAD_ERROR_HTTP_CLIENT_SIDE_ERROR = 4;
    UPLOAD_ERROR_UNKNOWN = 5;
}

enum EncryptedField {
    ENCRYPTED_FIELD_SHARE_KEY = 0;
    ENCRYPTED_FIELD_NODE_KEY = 1;
    ENCRYPTED_FIELD_NODE_NAME = 2;
    ENCRYPTED_FIELD_NODE_HASH_KEY = 3;
    ENCRYPTED_FIELD_NODE_EXTENDED_ATTRIBUTES = 4;
    ENCRYPTED_FIELD_NODE_CONTENT_KEY = 5;
    ENCRYPTED_FIELD_CONTENT = 6;
}

message UploadEventPayload {
    VolumeType volume_type = 1;
    int64 expected_size = 2;
    int64 uploaded_size = 3;
    int64 approximate_uploaded_size = 4; // To be used when exact size must not be communicated in order to prevent fingerprinting
    UploadError error = 5; // Optional
    string original_error = 6; // Optional
} 

message DownloadEventPayload {
    VolumeType volume_type = 1;
    int64 claimed_file_size = 2; // -1 if unknown
    int64 downloaded_size = 3;
    DownloadError error = 4; // Optional
    string original_error = 5; // Optional
}
 
message DecryptionErrorEventPayload {
    VolumeType volume_type = 1;
    EncryptedField field = 2;
    bool from_before_2024 = 3;
    string error = 4; // Optional
    string uid = 5;
}

message VerificationErrorEventPayload {
    VolumeType volume_type = 1;
    EncryptedField field = 2;
    bool from_before_2024 = 3;
    bool address_matching_default_share = 4;
    string error = 5; // Optional
    string uid = 6;
}
 
message BlockVerificationErrorEventPayload {
    bool retry_helped = 1;
}

message NodeNameConflictErrorData {
    bool conflicting_node_is_file_draft = 1;
    string conflicting_node_uid = 2;
    string conflicting_revision_uid = 3;
}
